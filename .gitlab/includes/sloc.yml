# Copyright (c) 2024 ETH Zurich
#
# SPDX-License-Identifier: BSL-1.0
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file BOOST_LICENSE_1_0.rst or copy at http://www.boost.org/LICENSE_1_0.txt)

include:
  - local: '.gitlab/includes/common_pipeline.yml'

sloc_base_image:
  extends: [.container-builder-cscs-zen2]
  variables:
    BASE_IMAGE: docker.io/ubuntu:22.04
    DOCKERFILE: .gitlab/docker/Dockerfile.sloc_base
    DOCKER_BUILD_ARGS: '["BASE_IMAGE"]'
  before_script:
    - export DOCKERFILE_SHA=`sha256sum $DOCKERFILE | head -c 16`
    - export CONFIG_TAG=`echo $DOCKERFILE_SHA-$BASE_IMAGE | sha256sum - | head -c 16`
    - export PERSIST_IMAGE_NAME=$CSCS_REGISTRY_PATH/$ARCH/public/pika-sloc:$CONFIG_TAG
    - echo -e "CONFIG_TAG=$CONFIG_TAG" >> sloc_base.env
    - echo -e "BASE_IMAGE=$PERSIST_IMAGE_NAME" >> sloc_base.env
  artifacts:
    reports:
      dotenv: sloc_base.env

sloc:
  needs: [sloc_base_image]
  extends: [.container-runner-lightweight-zen2]
  image: $BASE_IMAGE
  variables:
    GIT_STRATEGY: fetch
  script:
    - ${CI_PROJECT_DIR}/.gitlab/scripts/sloc.sh ${CI_PROJECT_DIR}
